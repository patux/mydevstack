#!/bin/bash
# Base template to create a local.conf to bulid devstack
#
# A reference for a good local.conf here:
# http://www.sebastien-han.fr/blog/2013/08/16/best-local.conf-for-devstack/
#
. /etc/environment
# Adding havana repo
sudo apt-get install -y python-software-properties 
sudo add-apt-repository -y cloud-archive:havana
sudo apt-get update -y
sudo apt-get -y dist-upgrade

# start the devstack local.conf configuration
git clone https://github.com/openstack-dev/devstack.git -b <%= @devstack_branch %> devstack
cd devstack
git checkout <%= @devstack_branch %>
# Build local.conf
# Misc
echo [[local\|local.conf]] > local.conf
echo DATABASE_PASSWORD=password > local.conf
echo RABBIT_PASSWORD=password >> local.conf
echo SERVICE_TOKEN=password >> local.conf
echo SERVICE_PASSWORD=password >> local.conf
echo ADMIN_PASSWORD=password >> local.conf
echo LOGFILE=/opt/stack/stack.sh.log >> local.conf
echo >> local.conf 
echo disable_service n-net >> local.conf
echo enable_service q-svc >> local.conf
echo enable_service q-agt >> local.conf
echo enable_service q-dhcp >> local.conf
echo enable_service q-l3 >> local.conf
echo enable_service q-meta >> local.conf
echo enable_service neutron >> local.conf
echo enable_service n-novnc >> local.conf
echo enable_service n-xvnc >> local.conf
echo enable_service n-cauth >> local.conf
# Optional, to enable tempest configuration as part of devstack
echo  enable_service tempest >> local.conf
cat << EOF >> local.conf 
# Reclone each time
IMAGE_URLS+=",https://launchpad.net/cirros/trunk/0.3.0/+download/cirros-0.3.0-x86_64-disk.img"
RECLONE=yes

## For Keystone
KEYSTONE_TOKEN_FORMAT=PKI

# Enable Logging
VERBOSE=True
LOG_COLOR=True
SCREEN_LOGDIR=/opt/stack/logs
LOGFILE=/opt/stack/stack.sh.log
LOGDAYS=2

# Horizon (Dashboard UI) - (always use the trunk)
ENABLED_SERVICES+=,horizon

IMAGE_URLS+=",https://launchpad.net/cirros/trunk/0.3.0/+download/cirros-0.3.0-x86_64-disk.img"
IMAGE_URLS+=",http://fedorapeople.org/groups/heat/prebuilt-jeos-images/F17-x86_64-cfntools.qcow2,http://cloud-images.ubuntu.com/precise/current/precise-server-cloudimg-amd64-disk1.img"

EOF
<% if has_variable?("ipaddress_eth1") %><% then %>
    echo HOST_IP=<%= @ipaddress_eth1 %> >> local.conf
    FLAT_INTERFACE=eth1
<% else %>
    echo HOST_IP=<%= @ipaddress_eth1 %> >> local.conf
    FLAT_INTERFACE=eth0
<% end %>

# Build local.sh script
cat << EOS > $HOME/devstack/local.sh
#!/bin/bash
set -o xtrace

echo "Running local.sh"

openrc=/home/vagrant/devstack/openrc

if is_service_enabled n-api; then
    for user in admin demo; do
        source \$openrc \$user \$user
        nova keypair-add --pub-key /home/vagrant/.host_ssh/id_rsa.pub
        nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0
        nova secgroup-add-rule default tcp 22 22 0.0.0.0/0
    done
fi
elif is_service_enabled neutron; then
    for user in admin demo; do
        source \$openrc \$user \$user
        nova keypair-add --pub-key /home/vagrant/.host_ssh/id_rsa.pub
        neutron security-group-rule-create --protocol icmp --direction ingress default
        neutron security-group-rule-create --protocol tcp --port-range-min 22 --port-range-max 22 --direction ingress default
    done
fi
# Allowing guests in DevStack to talk to outside world 
# https://ask.openstack.org/en/question/1830/allowing-guests-in-devstack-to-talk-to-outside-world/
/sbin/iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
# Save lists
# https://help.ubuntu.com/community/IptablesHowTo
/sbin/iptables-save -c > /etc/iptables.rules
cat << EOF > /etc/network/if-pre-up.d/iptablesload
#!/bin/sh
/sbin/iptables-restore < /etc/iptables.rules
exit 0
EOF
cat << EOF > /etc/network/if-post-down.d/iptablessave
#!/bin/sh
/sbin/iptables-save -c > /etc/iptables.rules
if [ -f /etc/iptables.downrules ]; then
    /sbin/iptables-restore < /etc/iptables.downrules
fi
exit 0
EOF
chmod +x /etc/network/if-post-down.d/iptablessave
chmod +x /etc/network/if-pre-up.d/iptablesload
EOS

./stack.sh
